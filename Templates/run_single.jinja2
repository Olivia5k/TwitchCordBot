{% extends "base.jinja2" %}

{% block title %}
  {{ run.display_name }}
{% endblock %}

{% block content %}
  <script type="text/javascript">
   document.onkeydown = function(evt) {
     {% if runs.previous %}
     if (evt.key === "ArrowLeft") {
       window.location.href = "/runs/{{ runs.previous.name }}";
     }
     {% endif %}

     {% if runs.next %}
     if (evt.key === "ArrowRight") {
       window.location.href = "/runs/{{ runs.next.name }}";
     }
     {% endif %}
   }
  </script>

  <script type="text/javascript">
   // If you're reading this nonsense, I'm sorry.

   function neowText(header, bodyText) {
     // Set the header
     document.getElementById("neow-header").innerHTML = header;
     // Hide the original content
     document.getElementById("neow-body-original").className = "message-body hidden"
     // Set the new content and make it appear
     document.getElementById("neow-body-content").innerHTML = bodyText;
     document.getElementById("neow-body-new").className = "message-body";
   }

   function neowReset() {
     document.getElementById("neow-header").innerHTML = "Neow bonus";
     document.getElementById("neow-body-new").className = "message-body hidden"
     document.getElementById("neow-body-original").className = "message-body"
   }
  </script>

  <script type="text/javascript">
   // TODO(olivia): We can probably grab more descriptive names for more
   // floors than just Neow and Mr. Heart! ðŸ˜Ž
   const labels = [
     'Neow',
     {% for x in range(1, 55) %}
     'Floor {{ x }}',
     {% endfor %}
     'Mr. Heart',
   ];

   const data = {
     labels: labels,
     datasets: [{
       label: 'HP',
       backgroundColor: '#ff6384',
       borderColor: '#ff6384',
       data: {{ run.current_hp_per_floor }},
       yAxisID: 'y',
     },{
       label: 'Max HP',
       backgroundColor: '#8463ff',
       borderColor: '#8463ff',
       borderWidth: 1,
       radius: 0,
       data: {{ run.max_hp_per_floor }},
       yAxisID: 'y',
     },{
       label: 'Gold',
       backgroundColor: '#ffd700',
       borderColor: '#ffd700',
       data: {{ run.gold_per_floor }},
       yAxisID: 'y1',
     }]
   };

   const config = {
     type: 'line',
     data: data,
     options: {
       responsive: true,
       interaction: {
         mode: 'index',
         intersect: false,
       },
       stacked: false,
       scales: {
         y: {
           min: 0
         },
         y1: {
           type: 'linear',
           display: true,
           position: 'right',
           grid: {
             drawOnChartArea: false, // only want the grid lines for one axis to show up
           },
         },
       }
     }
   };
  </script>


  <nav class="breadcrumb" aria-label="breadcrumbs">
    <ul>
      <li><a href="/runs">Run histories</a></li>
      <li><a href="/profile/{{ run.profile.index }}/runs">{{ run.profile.name }}</a></li>
      <li class="is-active"><a href="#">
        {{ run.character }} {{ run.verb }}, {{ run.timestamp.strftime("%A %-d
    %B, %H:%M") }}
      </a></li>
    </ul>
  </nav>

  <section class="section">
    <div class="box run-header is-paddingless">
      <div class="avatar">
        <img class="{{ run.character | lower }} {{ run.verb }}"
          src="/static/characters/{{ run.character | lower }}-{{ run.verb }}.png"/>
      </div>
      <div class="container">
        <div class="run-title pt-4 pr-4 pb-4">
          <div class="title">
            {{ run.character }}
            {% if run.won %}
              victory! ðŸŽ‰
            {% else %}
              loss ðŸ˜”
            {% endif %}
          </div>
          <div class="score">
            <div class="points">
              {{ run.score }} points
              {% if run.ascension_level != 20 %}
                (A{{ run.ascension_level }})
              {% endif %}
            </div>
            {% if not run.won %}
              <div class="loss">
                Killed by {{ run.killed_by }} on floor {{ run.floor_reached }}
              </div>
            {% endif %}
          </div>
          <div class="extra">
            <div>Took {{ run.run_length }}</div>
            <div title="{{ run.timestamp }}">
              {% if run.delta.days > 0 %}
                {{ run.delta.days }} days ago
              {% else %}
                Today!
              {% endif %}
            </div>
            <div>{{ run.seed }}</div>
          </div>
          {% if modded %}
            <i title="This is a modded character. Not all data will be accurate."
              class="fa-solid fa-circle-radiation"></i>
          {% endif %}
        </div>
      </div>
    </div>
  </section>
  <section class="section">
    <div class="columns is-marginless">
      <div class="column message neow is-paddingless is-marginless box">
        <div class="message-header">
          <p id="neow-header">Neow bonus</p>
        </div>
        <div id="neow-body-original" class="message-body">
          <p>
            {{ run.neow_bonus.as_str() }}
          </p>
          {% if run.neow_bonus.has_data %}
            <div class="skipped">
              <p>And we skipped taking:</p>
              <ul>
                {% for skipped in run.neow_bonus.skipped %}
                  <li> {{ skipped }} </li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
        </div>
        <div id="neow-body-new" class="message-body hidden">
          <p id="neow-body-content"></p>
        </div>
      </div>

      <div class="column is-one-fifth">
        <div class="keys">
          {# Since we want the keys to be rendered in a specific order, we
          can't just loop  #}
          {% for key in ("Emerald Key", "Ruby Key", "Sapphire Key") %}
            <img class="{{ key | lower }} {% if key not in keys %} missing{% endif %}"
              src="/static/relics/cropped/{{ key | urlencode }}.png"
              onclick="neowText('{{ key }}',
                      {% if key in keys %}
                      'Obtained on floor {{ keys[key] }}'
                      {% else %}
                      'This key hasn\'t been obtained yet.'
                      {% endif %})">
          {% endfor %}
        </div>
        <div class="hint" onclick="neowReset()">
          <p>Hint: You can click on relics, floors, and the keys.</p>
        </div>
      </div>

      <div class="column message relics-message is-paddingless is-marginless box">
        <div class="message-header">
          <p>Relics</p>
        </div>
        <div class="message-body relics">
          {% for relic in run.relics %}
            <div>
              <img src="/static/relics/cropped/{{ relic.image | urlencode }}"
                alt="{{ relic.description() }}"
                title="{{ relic.description() }}"
                onclick="neowText('{{ relic.name | replace("'", "\\'") }}', '{{relic.escaped_description() }}')" >
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </section>

  <section class="section">
    <div class="act">
      {% for node in run.path %}
        <img src="/static/icons/{{ node.map_icon }}"
          title="Floor {{ node.floor }}"
          onclick="neowText('Floor {{ node.floor }}', '{{ node.escaped_description() }}')">
        {# This is unfortunate logic, but it does the thing. #}
        {% if node.end_of_act %}
    </div>
    <div class="act">
        {% endif %}
      {% endfor %}
    </div>
  </section>

  <section class="section">
    <div class="cards">
      {% for card_data in run.cards_as_html() %}
        {{ card_data | safe }}
      {% endfor %}
    </div>
  </section>

  <section class="section">
    <div class="charts">
      <canvas id="chart"></canvas>
      <script type="text/javascript">
       const myChart = new Chart(
         document.getElementById('chart'),
         config
       );
      </script>

    </div>
  </section>

  <!-- <section class="section">
       {% if embed %}
       <br>
       <b>Tip: the graphs below can be interacted with, using the buttons in the bottom left!</b>
       <br>
       <embed type="text/html" src="/runs/{{ run.name }}/plot?view=max_hp,current_hp&title=Progression+of+HP+during+the+run&label=HP&type=embed" title="Progression of HP during the run" width=670 height=500>
       <embed type="text/html" src="/runs/{{ run.name }}/plot?view=gold&title=Progression+of+gold+during+the+run&type=embed" title="Progression of gold during the run" width=670 height=500>
       <embed type="text/html" src="/runs/{{ run.name }}/plot?view=card_count&title=Card+count+during+the+run&type=embed" title="Card count during the run" width=670 height=500>
       <embed type="text/html" src="/runs/{{ run.name }}/plot?view=relic_count&title=Relic+count+during+the+run&type=embed" title="Relic count during the run" width=670 height=500>
       <embed type="text/html" src="/runs/{{ run.name }}/stem?view=potion_count&title=Potion+count+during+the+run&type=embed" title="Potion count during the run" width=670 height=500>
       <embed type="text/html" src="/runs/{{ run.name }}/bar?view=floor_time&title=Time+spent+on+each+floor&type=embed" title="Time spent on each floor" width=670 height=500>
       {% else %}
       <img src="/runs/{{ run.name }}/plot?view=max_hp,current_hp&title=Progression+of+HP+during+the+run&label=HP&type=image" alt="Progression of HP during the run">
       <img src="/runs/{{ run.name }}/plot?view=gold&title=Progression+of+gold+during+the+run&type=image" alt="Progression of gold during the run">
       <img src="/runs/{{ run.name }}/plot?view=card_count&title=Card+count+during+the+run&type=image" alt="Card count during the run">
       <img src="/runs/{{ run.name }}/plot?view=relic_count&title=Relic+count+during+the+run&type=image" alt="Relic count during the run">
       <img src="/runs/{{ run.name }}/stem?view=potion_count&title=Potion+count+during+the+run&type=image" alt="Potion count during the run">
       <img src="/runs/{{ run.name }}/bar?view=floor_time&title=Time+spent+on+each+floor&type=image" alt="Time spent on each floor">
       {% endif %}
       </section> -->

{% endblock %}

{% block footer %}
  {% if embed %}
    <a href="/runs/{{ run.name }}?embed=false{% if redirect %}&redirect=true{% endif %}">Graphs not loading? Click here!</a>
    <br>
  {% endif %}
  <a href="/profile/{{ run.profile.index }}/runs">Back to all runs</a><br>
{% endblock %}
