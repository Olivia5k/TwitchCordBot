{% extends "base.jinja2" %}

{% block title %}
  {{ run.display_name }}
{% endblock %}

{% block head %}
  {% if autorefresh %}
    <!-- Refresh the page every 15 seconds; savefile gets regularly updated.
         Actual code will properly cache the savefile and serve latest -->
    <meta http-equiv="refresh"
      content="{% if redirect and parser.in_game %}0;url=/current{% else %}15{% endif %}">
  {% endif %}
{% endblock %}

{% block content %}
  {% if run.done or run.in_game %}
    <script type="text/javascript">
     // If you're reading this nonsense, I'm sorry.

     function neowText(header, bodyText) {
       // Set the header
       document.getElementById("neow-header").innerHTML = header;
       // Hide the original content
       document.getElementById("neow-body-original").className = "message-body hidden"
       // Set the new content and make it appear
       document.getElementById("neow-body-content").innerHTML = bodyText;
       document.getElementById("neow-body-new").className = "message-body";
     }

     function neowReset() {
       document.getElementById("neow-header").innerHTML = "Neow bonus";
       document.getElementById("neow-body-new").className = "message-body hidden"
       document.getElementById("neow-body-original").className = "message-body"
     }
    </script>

    <script type="text/javascript">
     // TODO(olivia): We can probably grab more descriptive names for more
     // floors than just Neow and Mr. Heart! ðŸ˜Ž
     const labels = [
       'Neow',
       {% for x in range(1, 55) %} 'Floor {{ x }}', {% endfor %}
       'Mr. Heart',
     ];

     const data = {
       labels: labels,
       datasets: [{
         label: 'HP',
         backgroundColor: '#ff6384',
         borderColor: '#ff6384',
         data: {{ run.current_hp_counts }},
         yAxisID: 'y',
       },{
         label: 'Max HP',
         backgroundColor: '#8463ff',
         borderColor: '#8463ff',
         borderWidth: 1,
         radius: 0,
         data: {{ run.max_hp_counts }},
         yAxisID: 'y',
       },{
         label: 'Gold',
         backgroundColor: '#ffd700',
         borderColor: '#ffd700',
         data: {{ run.gold_counts }},
         yAxisID: 'y1',
       }]
     };

     const config = {
       type: 'line',
       data: data,
       options: {
         responsive: true,
         interaction: {
           mode: 'index',
           intersect: false,
         },
         stacked: false,
         scales: {
           y: {
             min: 0
           },
           y1: {
             type: 'linear',
             display: true,
             position: 'right',
             min: 0,
             grid: {
               drawOnChartArea: false, // only want the grid lines for one axis to show up
             },
           },
         }
       }
     };
    </script>

    {% if run.done %}
      {# We only show this when looking at run histories #}
      <nav class="breadcrumb" aria-label="breadcrumbs">
        <ul>
          <li><a href="/runs">Run histories</a></li>
          <li><a href="/profile/{{ run.profile.index }}/runs">{{ run.profile.name }}</a></li>
          <li class="is-active">
            <a href="#">
              {{ run.character }} {{ run.verb }},
              {{ run.timestamp.strftime("%A %-d %B, %H:%M") }}
            </a>
          </li>
        </ul>
      </nav>
    {% endif %}

    {% include "partials/run_header.jinja2" %}

    <section class="section">
      <div class="columns is-marginless">
        <div class="column message neow is-paddingless is-marginless box">
          <div class="message-header">
            <p id="neow-header">Neow bonus</p>
          </div>
          <div id="neow-body-original" class="message-body">
            <p>
              {{ run.neow_bonus.as_str() }}
            </p>
            {% if run.neow_bonus.has_data %}
              <div class="skipped">
                <p>And we skipped taking:</p>
                <ul>
                  {% for skipped in run.neow_bonus.skipped %}
                    <li> {{ skipped }} </li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
          </div>
          <div id="neow-body-new" class="message-body hidden">
            <p id="neow-body-content"></p>
          </div>
        </div>

        <div class="column is-one-fifth">
          <div class="keys">
            {# Since we want the keys to be rendered in a specific order, we
            can't just loop  #}
            {% for key in ("Emerald Key", "Ruby Key", "Sapphire Key") %}
              <img class="{{ key | lower }} {% if key not in keys %} missing{% endif %}"
                src="/static/relics/cropped/{{ key | urlencode }}.png"
                onclick="neowText('{{ key }}',
                      {% if key in keys %}
                      'Obtained on floor {{ keys[key] }}'
                      {% else %}
                      'This key hasn\'t been obtained yet.'
                      {% endif %})">
            {% endfor %}
          </div>
          <div class="hint" onclick="neowReset()">
            <p>Hint: You can click on relics, floors, cards, and the keys.</p>
          </div>
        </div>

        <div class="column message relics-message is-paddingless is-marginless box">
          <div class="message-header">
            <p>Relics</p>
          </div>
          <div class="message-body relics">
            {% for relic in run.relics %}
              <div>
                <img src="/static/relics/cropped/{{ relic.image | urlencode }}"
                  alt="{{ relic.description() }}"
                  title="{{ relic.description() }}"
                  onclick="neowText('{{ relic.name | replace("'", "\\'") }}', '{{relic.escaped_description() }}')" >
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="act">
        {% for node in run.path %}
          <img src="/static/icons/{{ node.map_icon }}"
            title="Floor {{ node.floor }}"
            onclick="neowText('Floor {{ node.floor }}', '{{ node.escaped_description() }}')">
          {# This is unfortunate logic, but it does the thing. #}
          {% if node.end_of_act %}
      </div>
      <div class="act">
          {% endif %}
        {% endfor %}
      </div>
    </section>

    <section class="section">
      <div class="cards">
        {% for card_data in run.cards_as_html() %}
          {{ card_data | safe }}
        {% endfor %}
      </div>
    </section>

    <section class="section">
      <div class="charts">
        <canvas id="chart"></canvas>
        <script type="text/javascript">
         const myChart = new Chart(
           document.getElementById('chart'),
           config
         );
        </script>

      </div>
    </section>
    {% else %}
    <section class="section mt-4">
      <div class="columns is-centered has-text-centered mt-4">
        <div class="column">
          <h1 class="title">
            No run is currently going on!
          </h1>
          <p>
            Stick around until Baalor starts one.
          </p>
          <p>
            You may need to wait until after he picked a Neow bonus before the
            data gets here.
          </p>
        </div>
      </div>
    </section>
  {% endif %}
{% endblock %}

{% block footer %}
  {% if embed %}
    <a href="/runs/{{ run.name }}?embed=false{% if redirect %}&redirect=true{% endif %}">Graphs not loading? Click here!</a>
    <br>
  {% endif %}
  <a href="/profile/{{ run.profile.index }}/runs">Back to all runs</a><br>
{% endblock %}
